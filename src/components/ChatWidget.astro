<!-- Chat Widget - María (Orquest AI Assistant) -->
<div id="mw-widget">
  <button id="mw-toggle" aria-label="Abrir chat">
    <svg id="mw-icon-open" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
    </svg>
    <svg id="mw-icon-close" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none">
      <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
    </svg>
  </button>

  <div id="mw-window" class="mw-hidden">
    <div id="mw-header">
      <div id="mw-header-info">
        <div id="mw-avatar">M</div>
        <div>
          <div id="mw-name">Maria</div>
          <div id="mw-subtitle">Asesora Orquest</div>
        </div>
      </div>
      <button id="mw-close" aria-label="Cerrar chat">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div id="mw-messages"></div>
    <form id="mw-form">
      <input id="mw-input" type="text" placeholder="Escribe tu mensaje..." autocomplete="off" />
      <button type="submit" id="mw-send" aria-label="Enviar">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      </button>
    </form>
  </div>
</div>

<style is:global>
  #mw-widget {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 9999;
    font-family: 'Inter', sans-serif;
  }

  #mw-toggle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #7c3aed, #06b6d4);
    border: none;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 24px rgba(124, 58, 237, 0.4);
    transition: transform 0.2s, box-shadow 0.2s;
  }

  #mw-toggle:hover {
    transform: scale(1.08);
    box-shadow: 0 6px 32px rgba(124, 58, 237, 0.6);
  }

  #mw-window {
    position: absolute;
    bottom: 76px;
    right: 0;
    width: 380px;
    max-width: calc(100vw - 32px);
    height: 520px;
    max-height: calc(100vh - 120px);
    background: #1a1a2e;
    border-radius: 16px;
    border: 1px solid rgba(124, 58, 237, 0.3);
    box-shadow: 0 8px 40px rgba(0, 0, 0, 0.5);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: opacity 0.25s, transform 0.25s;
  }

  #mw-window.mw-hidden {
    opacity: 0;
    transform: translateY(16px) scale(0.95);
    pointer-events: none;
  }

  #mw-header {
    background: linear-gradient(135deg, #7c3aed, #5b21b6);
    padding: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }

  #mw-header-info {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  #mw-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 18px;
    color: white;
  }

  #mw-name {
    font-weight: 600;
    font-size: 16px;
    color: white;
  }

  #mw-subtitle {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.7);
  }

  #mw-close {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: color 0.2s;
  }

  #mw-close:hover {
    color: white;
  }

  #mw-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  #mw-messages::-webkit-scrollbar {
    width: 4px;
  }

  #mw-messages::-webkit-scrollbar-thumb {
    background: rgba(124, 58, 237, 0.4);
    border-radius: 4px;
  }

  /* === Messages === */
  .mw-msg {
    display: flex;
    flex-direction: column;
    max-width: 85%;
  }

  /* Tu = izquierda */
  .mw-msg.mw-user {
    align-self: flex-start;
    align-items: flex-start;
  }

  /* Maria = derecha */
  .mw-msg.mw-bot {
    align-self: flex-end;
    align-items: flex-end;
  }

  /* Labels */
  .mw-label {
    font-size: 10px;
    font-weight: 700;
    margin-bottom: 4px;
    padding: 0 8px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
  }

  .mw-msg.mw-bot .mw-label {
    color: #a78bfa;
  }

  .mw-msg.mw-user .mw-label {
    color: #22d3ee;
  }

  /* Bubbles */
  .mw-bubble {
    padding: 10px 14px;
    border-radius: 14px;
    font-size: 14px;
    line-height: 1.5;
    word-wrap: break-word;
  }

  /* Maria bubble - derecha, violeta */
  .mw-msg.mw-bot .mw-bubble {
    background: #252540;
    color: #e2e8f0;
    border-top-right-radius: 4px;
    border-left: 3px solid #7c3aed;
  }

  /* Tu bubble - izquierda, cyan */
  .mw-msg.mw-user .mw-bubble {
    background: #1a2e3a;
    color: #e2e8f0;
    border-top-left-radius: 4px;
    border-right: 3px solid #06b6d4;
  }

  /* Payment link buttons */
  .mw-pay-link {
    display: block;
    margin: 8px 0 2px;
    padding: 8px 14px;
    background: linear-gradient(135deg, #7c3aed, #5b21b6);
    color: white !important;
    border-radius: 8px;
    text-decoration: none;
    font-size: 13px;
    font-weight: 600;
    text-align: center;
    transition: opacity 0.2s;
    width: fit-content;
  }

  .mw-pay-link:hover {
    opacity: 0.85;
  }

  /* Typing animation */
  .mw-typing .mw-bubble {
    display: flex;
    gap: 4px;
    padding: 12px 18px;
  }

  .mw-dot {
    width: 8px;
    height: 8px;
    background: rgba(124, 58, 237, 0.5);
    border-radius: 50%;
    animation: mwtyping 1.2s infinite;
  }

  .mw-dot:nth-child(2) { animation-delay: 0.2s; }
  .mw-dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes mwtyping {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
    30% { transform: translateY(-6px); opacity: 1; }
  }

  #mw-form {
    display: flex;
    padding: 12px;
    gap: 8px;
    border-top: 1px solid rgba(124, 58, 237, 0.2);
    background: #151525;
    flex-shrink: 0;
  }

  #mw-input {
    flex: 1;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(124, 58, 237, 0.2);
    border-radius: 10px;
    padding: 10px 14px;
    color: white;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
  }

  #mw-input::placeholder {
    color: rgba(255, 255, 255, 0.4);
  }

  #mw-input:focus {
    border-color: #7c3aed;
  }

  #mw-send {
    width: 42px;
    height: 42px;
    border-radius: 10px;
    background: linear-gradient(135deg, #7c3aed, #06b6d4);
    border: none;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s;
    flex-shrink: 0;
  }

  #mw-send:hover {
    opacity: 0.85;
  }

  #mw-send:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  @media (max-width: 480px) {
    #mw-widget {
      bottom: 16px;
      right: 16px;
    }
    #mw-window {
      width: calc(100vw - 32px);
      height: calc(100vh - 100px);
      bottom: 72px;
      right: -8px;
    }
  }
</style>

<script is:inline>
  (function() {
    var CHAT_API = 'https://bot.orquestsystems.com/chat';

    var toggleBtn = document.getElementById('mw-toggle');
    var chatWindow = document.getElementById('mw-window');
    var closeBtn = document.getElementById('mw-close');
    var form = document.getElementById('mw-form');
    var input = document.getElementById('mw-input');
    var messagesEl = document.getElementById('mw-messages');
    var iconOpen = document.getElementById('mw-icon-open');
    var iconClose = document.getElementById('mw-icon-close');
    var sendBtn = document.getElementById('mw-send');

    var sessionId = null;
    var isOpen = false;

    // Mensaje inicial de Maria
    addMessage('Hola, soy Maria, asesora comercial de ORQUEST - Systems & Automation. ¿En que puedo ayudarte?', 'bot');

    function toggleChat() {
      isOpen = !isOpen;
      if (isOpen) {
        chatWindow.classList.remove('mw-hidden');
      } else {
        chatWindow.classList.add('mw-hidden');
      }
      iconOpen.style.display = isOpen ? 'none' : 'block';
      iconClose.style.display = isOpen ? 'block' : 'none';
      if (isOpen) input.focus();
    }

    toggleBtn.addEventListener('click', toggleChat);
    closeBtn.addEventListener('click', toggleChat);

    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatText(text) {
      var s = escapeHtml(text);
      // Saltos de línea → <br>
      s = s.replace(/\n/g, '<br>');
      // *negrita* → <strong>
      s = s.replace(/\*([^*\n]+)\*/g, '<strong>$1</strong>');
      // URLs de PayPal → botones clickeables
      s = s.replace(/(https?:\/\/[^\s<"]+)/g, function(url) {
        var label;
        if (url.indexOf('/ncp/payment/') !== -1) {
          label = 'Realizar pago &#8594;';
        } else if (url.indexOf('P-50T83312') !== -1) {
          label = 'Activar infraestructura — $5/mes &#8594;';
        } else if (url.indexOf('P-2TJ07823') !== -1) {
          label = 'Activar mantenimiento — $30/mes &#8594;';
        } else {
          label = 'Abrir enlace &#8594;';
        }
        return '<a href="' + url + '" target="_blank" rel="noopener" class="mw-pay-link">' + label + '</a>';
      });
      return s;
    }

    function addMessage(text, sender) {
      var div = document.createElement('div');
      div.className = 'mw-msg mw-' + sender;
      var label = sender === 'bot' ? 'Maria' : 'Tu';
      div.innerHTML = '<div class="mw-label">' + label + '</div><div class="mw-bubble">' + formatText(text) + '</div>';
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function showTyping() {
      var div = document.createElement('div');
      div.className = 'mw-msg mw-bot mw-typing';
      div.id = 'mw-typing';
      div.innerHTML = '<div class="mw-label">Maria</div><div class="mw-bubble"><div class="mw-dot"></div><div class="mw-dot"></div><div class="mw-dot"></div></div>';
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function hideTyping() {
      var el = document.getElementById('mw-typing');
      if (el) el.remove();
    }

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      var text = input.value.trim();
      if (!text) return;

      addMessage(text, 'user');
      input.value = '';
      sendBtn.disabled = true;
      showTyping();

      fetch(CHAT_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text, sessionId: sessionId, name: 'Visitante Web' })
      })
      .then(function(res) { return res.json(); })
      .then(function(data) {
        hideTyping();
        if (data.sessionId) sessionId = data.sessionId;
        var msgs = (data.messages && data.messages.length > 0) ? data.messages : (data.reply ? [data.reply] : null);
        if (!msgs) {
          addMessage('No pude procesar tu mensaje. Intenta de nuevo.', 'bot');
          sendBtn.disabled = false;
          input.focus();
          return;
        }
        // Renderizar cada parte como burbuja separada con delay entre ellas
        msgs.forEach(function(msg, i) {
          setTimeout(function() {
            addMessage(msg, 'bot');
            if (i === msgs.length - 1) {
              sendBtn.disabled = false;
              input.focus();
            }
          }, i * 900);
        });
      })
      .catch(function() {
        hideTyping();
        addMessage('Error de conexion. Verifica que el servicio este activo.', 'bot');
        sendBtn.disabled = false;
        input.focus();
      });
    });
  })();
</script>
